# TSObeliskSimulator
SQUARE ENIX社が提供するオンラインゲーム「FANTASY EARTH ZERO」の  
各マップの建築をシミュレートするツールです。

現在 https://saipan-fez.github.io/TSObeliskSimulator/  
跡地 http://obesim.toypark.in/

上記跡地の製作者よりソースコードを頂きました。

## マップ更新手順

FEZのマップに更新があった場合、下記の手順でマップ更新を反映する。

### 手順0. (前準備)作業用ブランチ作成
1. `git checkout -b feature/mapupdate`など適当なブランチ名で作業用ブランチを作成

### 手順1. 更新対象のマップ画像のキャプチャ

1. 各国の訓練所で話しかけ、マップ選択で更新対象のマップを選択する
2. マップがプレビュー表示されている所をキャプチャする

[実際のキャプチャ](img/1_mapcapture.png)

### 手順2. キープ設置可能距離の計測に用いる画像のキャプチャ

マップによってキープ建築可能な距離が異なるため、実際に建築可能な位置を計測する必要がある。  
計測を簡単に行うために、建築可能な位置を画像で保存しておく。  

1. 手順1を行い、訓練所でルームを作成してマップに入る
2. 建築からキープを選択し、建築可能な最小距離まで移動する
3. 移動後、その場所でキャプチャを撮影する

[実際のキャプチャ](img/2_keepcapture.png)

### 手順3. マップ画像の切り抜きと更新

1. 手順1で撮影した画像を`tool/MapClip/map/`以下に格納する
   ※格納時の名前は正式なマップ名にしておくこと
2. 下記でスクリプトを実行
    → 正常に実行できるとclipフォルダにマップ部分を切り抜いた画像が生成される
    ```bat
    cd tool/MapClip
    python main.py
    ```
4. 生成された更新対象のマップ画像を`docs/mapdata/image`に上書きコピーする

### 手順4. XMLの更新

1. `docs/mapdata/MapList.xml`を開く
2. 更新対象のマップの`<DefCastle>`と`<Crystal>`の位置を更新する
    1. `docs/`をrootとしてローカルサーバを立てて`index.html`を表示
    2. マップを更新対象のものに変更
    3. マウスポインタを動かしてキープ・クリスタルの位置に合わせて画像赤枠の座標を確認
       ![](img/4-positionupdate.png)
    4. 上記で確認した座標をXMLのPositionタグに更新する
       ※不要となったクリスタルの位置は併せて削除する
3. 更新対象のマップの`KeepSetDistance`属性を更新する
    1. 画像赤矢印の白い円の位置と手順2で撮影した最小距離が一致するよう、赤枠のスライダーを調整する
    2. 調整した距離の数値をXMLのKeepSetDistance属性に書き込む
       ※距離が`128`の場合はデフォルトの距離であるため明示的に記載しなくても問題はない
4. 更新漏れが無いかローカルサーバ上で確認する

### 手順5. サーバへの反映

1. 更新を`git commit`/`git push`でリモートリポジトリへ反映する
   コミットメッセージは `yyyyMMdd マップ更新を反映` とする(日付はFEZで実際に更新のあった日とする)
2. PullRequestを出す

PullRequestの内容に問題無ければ、masterへmergeします。
masterブランチへmergeされると、docsフォルダ以下の変更が自動的に反映されます。  
※反映には1-2時間ほどかかることもあるため注意
